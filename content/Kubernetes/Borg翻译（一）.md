---
weight: 10
title: "Borg翻译（一）"
date: "2018-11-12"
lastmod: "2018-11-12"
description:  "Borg是谷歌2015年发表的关于大规模集群管理的论文，Kubernetes是谷歌Borg系统的开源实现"
categories:  ["kubernetes"]
tags: ["kubernetes"]
---

## 介绍
谷歌有个叫Borg的集群管理系统，谷歌的所有应用程序都跑在这个系统上，Borg负责调度，启动，重启和监控这些应用程序。

Borg系统有三个主要的优点

**隐藏资源管理和故障处理的细节，以便用户可以专注于应用程序开发**

**以非常高的可靠性和可用性运行，支持同一个应用程序运行多个副本**

**有效地在数万台机器上运行工作负载（Workloads）**

集群管理系统有很多，但是能够管理数万台规模的系统很少，Borg是能在数万台规模下仍保证弹性和完整性的系统之一。

## 用户视角
Borg系统的用户是谷歌的开发人员和系统管理员，用户以jobs的形式将他们的工作提交给Borg，
每个jobs都包含一个或多个运行相同程序的tasks。每个job都在一个Borg Cell中运行。

*task: 一个应用程序实例*

*job: Borg系统运行job，一个job里有多个相同的task*

*cell: 多台主机组成一个cell*

## 工作负载（workload）
工作负载简单来说就是在Borg系统运行的任务或者作业，Borg系统上主要跑两种负载。

第一种，**长时间运行的并且不应该down机的服务**，对延迟比较敏感，需要快速响应（几百us到几百ms）。
这种应用主要是面向用户的产品，比如谷歌邮箱，谷歌文档，搜索引擎，和一些内部的基础设施服务，如BigTable。

第二种，**批处理任务**，运行时间从几秒到几天才能完成。这种应用对短期性能波动不太敏感。

不同的cell运行的工作负载不同，不同的租户，需求不一样，有的Cell运行第一种负载较多，
有的cell运行第二中负载较多，Borg需要妥善的处理这些情况。<br/><br/>

过去几年，谷歌把自己很多应用程序框架构建在Borg上，比如MapReduce系统，FlumeJava，Millwheel，
Pregelying，分布式存储系统GFS和他的儿子CFS，Bigtable和Megastore都跑在Borg上。

大多数长期运行的负载都是生产的（优先级较高）;大多数批处理作业都是非生产性的。
在一个有代表性cell中，给生产性作业分配CPU资源总量的70％左右，实际使用占CPU总使用量的60％左右;
给生产性作业分配了大约55％的总内存，实际使用占总内存使用量的85％左右。

## Clusters and cells
一个站点**(site)**由多个数据中心**(datacenter)**组成，一个数据中心就是一个集群**(Cluster)**，一个集群可能有
多个cell。
一个Cluster里通常包含一个大的cell，并且有一些小型用于测试或者特殊目的的cell。

在谷歌，一个cell的中位数是10k，一个cell由一万台配置，型号，架构不同的主机组成。
Borg向用户屏蔽了机器的差异，Borg为应用分配资源，监视运行状况，失败时重启它们。


## Jobs and tasks
job的属性包括job名称，job所有者以及job内task数量。
job可以有约束来强制其task在具有特定属性的计算机上运行，​​例如处理器体系结构，操作系统版本或外部IP地址。

约束可以是强约束或者弱约束，弱约束的行为就像偏好而不是要求。job可以延迟执行，等待上一个job结束
后再开始执行。一个job只在一个cell中运行。<br/><br/>

每个task都映射到在主机上的容器中运行的一组Linux进程。

绝大多数Borg工作负载不在虚拟机（VM）内运行，因为谷歌不想支付虚拟化的成本。此外，
设计Borg系统的时候谷歌已经买了很多处理器，那时候这些硬件还不支持虚拟化。<br/><br/>

task也有属性，例如其资源要求和job中的task索引。

一个job可以有很多个task，大多数task属性都是相同的，但task属性可以被覆盖，
例如，提供特定的命令行标志，提供新的cpu，内存资源额度，tcp端口等。

Borg程序是静态链接的，以减少对其运行时环境的依赖性，并构建为二进制文件和数据文件包，其安装由Borg编排。<br/><br/>

用户通过向Borg发出远程过程调用（RPCs）来操作job，最常见的是通过命令行工具，或者从其他job或谷歌的监控系统。

大多数job描述文件都是用BCL语言编写的，BCL是GCL的变体，GCL生成protobuf文件并使用一些特定于Borg的关键字
进行扩展。
GCL提供lambda函数以允许计算，应用程序使用它们来调整它们与环境的配置。

成千上万的BCL文件长度超过1000行，谷歌已经积累了数千万行BCL。Borg作业配置与Aurora配置文件有相似之处。<br/><br/>

用户想要更新job中的task时，就把新的job配置文件推送到Borg，然后就可以在Borg上用新的配置更新正在运行的task的属性。
这是一个轻量级的非原子事务，在关闭之前可以很容易地撤消。

更新通常以滚动方式完成，并且可以对更新导致的任务中断（重新安排或抢占）的数量施加限制，
任何会导致更多中断的更改都会被跳过。<br/><br/>

一些task更新需要重启（比如推送新的二进制文件），增加task的资源导致当前主机不适合运行这个task并重新
调度也会导致task重启。

另一些比如改变task优先级的操作不需要重启task就可以完成。

task可以在被SIGKILL信号杀死之前获取SIGTERM信号，从而有时间清理，保存状态，完成当前正在执行的任何请求，并拒绝新的请求。
