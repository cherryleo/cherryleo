---
weight: 12
title: "Borg翻译（二）"
date: "2018-11-22"
lastmod: "2018-11-22"
description:  "Borg如何管理和分配集群硬件资源，Borg上的任务如何访问与监控，任务的优先级如何分配"
categories:  ["kubernetes"]
tags: ["kubernetes"]
---

## 课代表划重点
__Borg管理成千上万的服务器，如何分配硬件资源？__

Borg把物理资源抽象为alloc进行分配。

__Borg运行成千上万的任务，如何协调任务的执行？__

为每个任务设定优先级，优先级高的优先占有资源并运行，可以抢占优先级低的资源。同时定义配额的概念，分配的额度是有使用期限的。

__Borg运行成千上万的任务，如何访问或者调用正在运行的服务？__

Borg为每个任务定义服务名，通过服务名进行调用。同时Borg会监控每个任务，任务失败Borg会重启任务。<br/><br/>

## Allocs（分配）
> Borg把物理资源抽象为alloc，任务运行在alloc定义的资源范围内，可以定义单个任务的alloc，也可以定义alloc set运行多个任务。

Borg的 __alloc__（allocation的缩写）是机器上分配给任务的一组预留资源，可以在其中运行一个或多个任务;不管是否使用这些资源，它们都被分配。

Allocs可用于为未来任务设置资源，在停止任务和再次启动任务之间保留资源，以及将来自不同作业的任务收集到同一台机器上。
可以把alloc等同于物理资源；在一个alloc内运行的多个任务共享它的资源。如果一个alloc必须被重新定位到另一台机器，那么任务会像alloc一样被重新调度。

__alloc set__：它是一组在多台机器上的保留资源。一旦创建了 __alloc set__，就可以提交一个或多个作业以在其中运行。<br/><br/>

## Priority, quota, and admission control（优先级，配额，准入控制）
> Borg运行的任务有优先级，优先级高的任务可以抢占优先级低任务的资源。并且可以为任务分配配额，配额指一段时间内
> 指定优先级具备多少资源的一个定义。

当更多的任务出现时，超出资源可容纳的范围，会发生什么？Borg的解决方案是优先级和配额。

每个作业都有一个优先级，一个小的正整数。高优先级的作业可以抢占低优先级作业的资源（即使杀死低优先级的作业）。
Borg为不同用途定义了不重叠的优先级区间，包括（按优先级递减顺序）：__monitoring, production, batch, 和 best effort(也叫testing 或 free)__。
在本文中，生产级的作业优先级是 __monitoring__ 和 __production__。<br/><br/>

虽然被抢占的任务经常会在 __cell__ 中的其他位置重新调度，但是如果高优先级任务遇到稍微低优先级的任务，而稍微低优先级任务又遇到另一个稍微低优先级的任务，则会发生抢占级联，以此类推。

为了消除大部分这种情况，Borg不允许处于 __production__ 优先级区间的作业相互抢占。
细粒度的优先级在其他情况下仍然有用，例如，MapReduce主节点以略高于从节点的优先级运行，以提高其可靠性。<br/><br/>

优先级表示在 __cell__ 中运行或等待运行的任务的相对重要性。配额被用来决定哪些作业要用于调度。

配额表示给定 __优先级__ 加 __一段时间__ 加 __资源数量__ 的向量。配额指定了用户的作业请求一次可以请求的最大资源量，
例如（例如，“从 __现在到7月底__ 在 __cell xx__ 中处于 __production优先级__ 的 __20TiB RAM__”）。

配额检查是准入控制的一部分，而不是调度：配额不足的作业在提交后立即被拒绝。<br/><br/>

高优先级的配额比低优先级的配额成本更高。生产优先级配额限制于 __cell__ 中可用的实际资源，以便提交符合其配额的生产优先级作业的用户能够期望它运行、模块化分段和约束。

尽管我们鼓励用户不要购买超过他们需要的配额，但是许多用户还是超额购买，因为当应用程序的用户基数增加时，它使他们免受未来短缺的影响。
对此，我们通过在较低优先级级别上超额销售配额进行响应：每个用户在优先级为零时都有无限的配额，尽管这常常很难执行，因为资源被超额订阅。

由于资源不足，低优先级作业会一致处于 __等待（未调度）__ 的状态。<br/><br/>

配额分配在Borg之外处理，并且与我们的物理容量计划紧密相关，其结果反映在不同的数据中心的价格和配额的可用性。
只有当用户作业在所需的优先级上具有足够的配额时，才允许用户作业。配额的使用减少了对诸如资源优势公平等政策的需求。

Borg有一个能力系统，它给予一些用户特殊的特权；例如，允许管理员删除或修改单元中的任何作业，或者允许用户访问受限制的内核特性或Borg行为，例如禁止对其作业的资源估计。<br/><br/>

## Naming and monitoring（命名和监控）
> Borg系统中的任务通过服务名发现和调用，通过高可用一致性文件存储数据。Borg会自动监控任务的健康状况，失败重启任务。

Borg可以创建和运行任务，但需要让客户端或者其他系统能够发现这些任务，不管这些任务是跑在哪台主机上。

为解决这个问题，Borg为每个任务创建一个稳定的 __“Borg name service”（BNS）__ 名称，包括 __cell名称、job名称和task编号__。

Borg将任务的 __主机名和端口__ 写入高可用一致性文件Chubby中，RPC系统通过Chubby文件中的条目来查找任务端点。
__BNS__ 名称还构成了任务DNS名称的基础，因此 __cell cc__ 中的 __用户ubar__ 拥有的 __作业jfoo__ 中的 __第50个任务__ 可以通过 __50.jfoo.ubar.cc.borg.google.com__ 访问。

Borg还在Chubby中写入任务大小和任务健康信息，这样负载均衡器就可以知道将请求路由到哪里。<br/><br/>

几乎所有在Borg下运行的任务都包含一个内置的HTTP服务器，该服务器发布关于任务健康状况和数以千计的性能指标（例如，RPC延迟）的信息。
Borg监视健康检查URL并重新启动 __没能立即响应或返回HTTP错误代码__ 的任务。
其他数据通过监控工具追踪，提供仪表板和服务违规的告警。<br/><br/>

称为Sigma的服务提供基于Web的用户界面（UI），用户可以通过该界面检查其所有作业、特定cell的状态，或者向下钻取到单个作业和任务，
以检查它们的资源行为、详细日志、执行历史以及最终状态。

我们的应用程序生成大量的日志；这些日志被 __自动流转（rotated）__ 以避免磁盘空间耗尽，并在任务退出后保留一段时间以协助调试。
如果作业没有运行，Borg提供了一个“why pending?”注解，同时提供指导如何修改作业的资源请求以更好地适应cell。
我们发布了“符合”__资源形状（resource shapes）__ 的指导方针，这些资源形状很可能很容易进行调度。<br/><br/>

Borg通过Dremel记录所有作业提交和任务事件，以及Infrastore中每个任务的详细资源使用信息，Infrastore是一个可伸缩的只读数据存储，具有交互式SQL接口。
这些数据用于基于使用的计费、调试作业和系统故障以及长期容量规划。它还提供了谷歌集群工作负载跟踪的数据。<br/><br/>

__所有这些特性都帮助用户理解和调试Borg及运行在Borg上的作业，并帮助SRE们每人管理几万台机器。__